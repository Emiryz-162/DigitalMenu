@model DigitalMenu.ViewModels.ProductViewModel
@{
    ViewData["Title"] = "Ürün Düzenle";
    var categoryName = ViewBag.CategoryName as string;
}

<!-- Dark Admin Navbar -->
<nav class="admin-navbar-dark">
    <div class="container-fluid px-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h3 class="text-white mb-0 fs-5">
                <i class="bi bi-pencil-fill me-2"></i>
                <span class="d-none d-md-inline">Ürün Düzenle - @categoryName</span>
                <span class="d-inline d-md-none">Düzenle</span>
            </h3>
            <div>
                <a asp-action="Products" asp-route-categoryId="@Model.CategoryId" class="btn btn-light-dark btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>
                    <span class="d-none d-sm-inline">Geri Dön</span>
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="admin-container-dark">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="admin-card-dark">
                <h4 class="text-white mb-4 fs-5">
                    <i class="bi bi-pencil-square me-2"></i>Ürün Bilgileri
                </h4>

                <form asp-action="EditProduct" method="post" enctype="multipart/form-data">
                    <input type="hidden" asp-for="Id" />
                    <input type="hidden" asp-for="CategoryId" />
                    <input type="hidden" asp-for="SortOrder" />
                    <input type="hidden" asp-for="ImagePath" />
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger-dark"></div>

                    <div class="mb-4">
                        <label asp-for="Name" class="form-label-dark">
                            <i class="bi bi-tag me-1"></i>Ürün Adı <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Name" class="form-control-dark" placeholder="Ürün adını girin" />
                        <span asp-validation-for="Name" class="text-danger small"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Description" class="form-label-dark">
                            <i class="bi bi-chat-square-text me-1"></i>Açıklama <span class="text-danger">*</span>
                        </label>
                        <textarea asp-for="Description" class="form-control-dark" rows="3" placeholder="Ürün içeriği, malzemeler..."></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                        <div class="form-text-dark">En fazla 1000 karakter</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label asp-for="Price" class="form-label-dark">
                                <i class="bi bi-currency-dollar me-1"></i>Fiyat <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text-dark">₺</span>
                                <input asp-for="Price" class="form-control-dark" type="number" step="0.01" min="0" placeholder="0.00" />
                            </div>
                            <span asp-validation-for="Price" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6 mb-4">
                            <label asp-for="Calories" class="form-label-dark">
                                <i class="bi bi-fire me-1"></i>Kalori <small class="text-muted">(Opsiyonel)</small>
                            </label>
                            <div class="input-group">
                                <input asp-for="Calories" class="form-control-dark" type="number" min="0" placeholder="Boş bırakabilirsiniz" />
                                <span class="input-group-text-dark">kcal</span>
                            </div>
                            <span asp-validation-for="Calories" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-dark">
                            <i class="bi bi-image me-1"></i>Mevcut Görsel
                        </label>
                        @if (!string.IsNullOrEmpty(Model.ImagePath))
                        {
                            <div class="text-center bg-preview-dark p-3 rounded">
                                <img src="@Model.ImagePath" alt="@Model.Name" id="currentImage" class="img-fluid rounded" style="max-height: 250px;">
                            </div>
                        }
                        else
                        {
                            <div class="empty-state-dark py-4">
                                <i class="bi bi-image" style="font-size: 3rem;"></i>
                                <p class="mb-0 small">Görsel bulunamadı</p>
                            </div>
                        }
                    </div>

                    <div class="mb-4">
                        <label asp-for="ImageFile" class="form-label-dark">
                            <i class="bi bi-upload me-1"></i>Yeni Görsel Yükle
                        </label>
                        <input asp-for="ImageFile" class="form-control-dark" type="file" accept="image/*" id="imageInput" />
                        <span asp-validation-for="ImageFile" class="text-danger small"></span>
                        <div class="form-text-dark">
                            <i class="bi bi-info-circle me-1"></i>Seçmezseniz mevcut görsel korunur
                        </div>
                        <div class="form-text-dark">
                            <strong>Format:</strong> JPG, PNG, WEBP • <strong>Max:</strong> 5MB
                        </div>

                        <!-- Yeni Görsel Önizleme -->
                        <div id="newImagePreview" class="mt-3 text-center bg-preview-dark p-3 rounded" style="display: none;">
                            <p class="text-success small mb-2">
                                <i class="bi bi-check-circle me-1"></i>Yeni Görsel
                            </p>
                            <img id="previewImg" src="" alt="Yeni Önizleme" class="img-fluid rounded" style="max-height: 250px;">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeNewImage">
                                <i class="bi bi-x-circle me-1"></i>Kaldır
                            </button>
                        </div>
                    </div>

                    <div class="alert-dark-info mb-4">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>İpucu:</strong> Ürün sıralamasını liste sayfasında sürükle-bırak ile değiştirebilirsiniz.
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning-dark btn-lg">
                            <i class="bi bi-save me-2"></i>Değişiklikleri Kaydet
                        </button>
                        <a asp-action="Products" asp-route-categoryId="@Model.CategoryId" class="btn btn-secondary-dark">
                            <i class="bi bi-x-circle me-2"></i>İptal
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const imageInput = document.getElementById('imageInput');
        const currentImage = document.getElementById('currentImage');
        const newPreview = document.getElementById('newImagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeBtn = document.getElementById('removeNewImage');

        // Yeni görsel seçildiğinde
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];

                if (file) {
                    // Dosya boyutu kontrolü (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Dosya boyutu 5MB\'dan küçük olmalıdır!');
                        e.target.value = '';
                        newPreview.style.display = 'none';
                        return;
                    }

                    // Dosya tipi kontrolü
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        alert('Sadece JPG, PNG ve WEBP formatları desteklenir!');
                        e.target.value = '';
                        newPreview.style.display = 'none';
                        return;
                    }

                    // Önizleme göster
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        newPreview.style.display = 'block';

                        // Mevcut görseli soluklaştır
                        if (currentImage) {
                            currentImage.style.opacity = '0.4';
                        }

                        newPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    reader.readAsDataURL(file);
                } else {
                    newPreview.style.display = 'none';
                    if (currentImage) {
                        currentImage.style.opacity = '1';
                    }
                }
            });
        }

        // Yeni görseli kaldır butonu
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                imageInput.value = '';
                newPreview.style.display = 'none';
                if (currentImage) {
                    currentImage.style.opacity = '1';
                }
            });
        }
    </script>
}